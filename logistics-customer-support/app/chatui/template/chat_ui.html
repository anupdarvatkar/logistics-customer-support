<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ID Proof OCR Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #f4f7f9; }
      .main-content-area { max-width: 600px; margin: 0 auto; }
      .thoughts-box { height: 40vh; overflow-y: auto; font-family: monospace; font-size: 0.9rem; background-color: #212529; color: #00ff41; margin-top: 1rem; }
      .message { padding: 0.5rem 1rem; border-radius: 1rem; margin-bottom: 1rem; }
      .agent-message { background-color: #e9ecef; color: #212529; }
      .thought-message { color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
    </style>
  </head>
  <body>
    <main class="container main-content-area" style="padding-top: 60px;">
      <h2 class="mb-4 text-center">ID Proof OCR Verification</h2>
      <div class="card">
        <div class="card-body" id="chat-box">
          <div class="message agent-message">
            Please upload your PAN card or government-issued ID for verification.
          </div>
        </div>
        <div class="card-footer p-3" id="input-area">
          <form id="upload-form">
            <div class="input-group">
              <input type="file" class="form-control" id="file-input" accept=".png,.jpg,.jpeg,.pdf" required>
              <button class="btn btn-success" type="submit">Upload and Verify</button>
            </div>
          </form>
        </div>
      </div>
      <div class="card thoughts-box" id="thoughts-box">
        <div class="text-muted">Waiting for ID upload...</div>
      </div>
    </main>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const chatBox = document.getElementById('chat-box');
      const thoughtsBox = document.getElementById('thoughts-box');
      const inputArea = document.getElementById('input-area');

      function addMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', 'agent-message');
        messageDiv.textContent = text;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function addThought(text) {
        if (thoughtsBox.querySelector('.text-muted')) {
          thoughtsBox.innerHTML = '';
        }
        const thoughtDiv = document.createElement('div');
        thoughtDiv.classList.add('thought-message');
        thoughtDiv.textContent = text;
        thoughtsBox.appendChild(thoughtDiv);
        thoughtsBox.scrollTop = thoughtsBox.scrollHeight;
      }

      async function handleUploadId(event) {
        event.preventDefault();
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (!file) return;

        addMessage(`Uploading ${file.name} for verification...`);
        inputArea.innerHTML = '<div class="text-center text-muted">Uploading and verifying...</div>';

        const formData = new FormData();
        formData.append('file', file);

        try {
          const response = await fetch('/api/chat/upload_id', {
            method: 'POST',
            body: formData
          });
          await processStream(response.body.getReader());
        } catch (error) {
          addMessage('File upload failed.');
          addThought(`Upload Error: ${error}`);
          renderUploadForm(); // Show form again on error
        }
      }

      async function processStream(reader) {
        const decoder = new TextDecoder();
        let resultShown = false;
        while (true) {
          const { value, done } = await reader.read();
          if (done) {
            addThought("Stream finished.");
            break;
          }
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n\n');
          for (const line of lines) {
            if (!line.startsWith('event:')) continue;
            const eventType = line.match(/event: (.*)/)[1];
            const dataStr = line.match(/data: (.*)/)[1];
            const data = JSON.parse(dataStr);

            switch (eventType) {
              case 'thought':
                addThought(data);
                break;
              case 'agent_message_chunk':
                addMessage(data);
                break;
              case 'validation_complete':
                addMessage("Verification Complete! Details: " + JSON.stringify(data, null, 2));
                addThought("ID validation successful.");
                resultShown = true;
                inputArea.innerHTML = '<div class="text-center text-success fw-bold">Verification complete!</div>';
                break;
              case 'error':
                addMessage(`An error occurred: ${data.message || data}`);
                addThought(`ERROR: ${JSON.stringify(data)}`);
                renderUploadForm();
                break;
              case 'stream_end':
                if (!resultShown) renderUploadForm();
                break;
            }
          }
        }
      }

      function renderUploadForm() {
        inputArea.innerHTML = `
          <form id="upload-form">
            <div class="input-group">
              <input type="file" class="form-control" id="file-input" accept=".png,.jpg,.jpeg,.pdf" required>
              <button class="btn btn-success" type="submit">Upload and Verify</button>
            </div>
          </form>
        `;
        document.getElementById('upload-form').addEventListener('submit', handleUploadId);
      }

      // Initialize
      renderUploadForm();
    });
    </script>
  </body>
</html>